面试题：来说说分布式锁吧

### 面试现场：

面试官：你知道分布式锁的实现方式有哪几种吗？

我：知道。数据库、redis、zk

面试官：嗯！（心想这小伙子还懂一点）那你知道他们优劣势以及他们的区别？

我：！@##￥%……&*（看下文）



### 分布式锁应该具备哪些条件

在分析分布式锁的三种实现方式之前，先了解一下分布式锁应该具备哪些条件：

> 1、在分布式系统环境下，一个方法在同一时间只能被一个机器的一个线程执行； 
> 2、高可用的获取锁与释放锁； 
> 3、高性能的获取锁与释放锁； 
> 4、具备可重入特性； 
> 5、具备锁失效机制，防止死锁； 
> 6、具备非阻塞锁特性，即没有获取到锁将直接返回获取锁失败。

### 分布式锁的三种实现方式

> 基于数据库实现分布式锁； 
> 基于缓存（Redis等）实现分布式锁； 
> 基于Zookeeper实现分布式锁；

### 基于数据库实现分布式锁

核心思想：在数据库中创建一个表，表中包含方法名等字段，并在方法名字段上创建唯一索引，想要执行某个方法，就使用这个方法名向表中插入数据，成功插入则获取锁，执行完成后删除对应的行数据释放锁。

**优点：直接操作数据库、容易理解**

**缺点：性能差，不具备高可用，不具备可重入的特性，容易死锁，没有锁失效机制**

### 基于Redis实现分布式锁

核心思想：获取锁的时候，使用setnx加锁，并使用expire命令为锁添加一个超时时间，超过该时间则自动释放锁。

**优点：使用方便、简单；性能高**

### 基于Zookeeper实现分布式锁

核心思想：由内部一个分层的文件系统目录树结构，规定同一个目录下只能有一个唯一文件名。

#### 实现步骤：

1、创建一个目录lock；

2、线程A想要获取就在lock目录下创建临时顺序节点；

3、获取lock目录下所有的子节点，然后获取比自己小的兄弟节点，如果不存在，则说明当前线程顺序号最小，获得锁；

4、线程B获取所有节点，判断自己不是最小节点，设置监听比自己次小的节点；

5、线程A处理完，删除自己的节点，线程B监听到变更事件，判断自己是不是最小的节点，如果是则获得锁。

**优点：具备高可用、可重入、阻塞锁特性，可解决死锁问题；**

**缺点：I/O操作频繁，性能不如Redis**

### 三种方案的比较：

**从理解的难易程度角度（从低到高）：**数据库>缓存>Zookeeper

**从实现的复杂性角度（从低到高）：**Zookeeper>=缓存>数据库

**从性能角度（从高到低）：**缓存>Zookeeper>数据库

**从可靠性角度（从高到低）：**Zookeeper>缓存>数据库



参考：

https://www.cnblogs.com/cxxjohnson/p/8998381.html

https://www.jianshu.com/p/350a5f891f11









